# Миграция с GPU на CPU

## Обзор изменений

Этот документ описывает изменения, внесенные для обеспечения совместимости с устройствами без GPU.

## Основные изменения

### 1. Dockerfile
- **Было**: `FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04`
- **Стало**: `FROM ubuntu:22.04`
- **Добавлено**: Установка CPU версии PyTorch

### 2. docker-compose.yml
**Удалены GPU-специфичные настройки:**
- `runtime: nvidia`
- `NVIDIA_VISIBLE_DEVICES=all`
- `CUDA_VISIBLE_DEVICES=0`
- `PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512`
- `CUDA_LAUNCH_BLOCKING=1`
- `deploy.resources.reservations.devices`

### 3. requirements.txt
- Удалены `torch` и `torchaudio` (устанавливаются отдельно как CPU версии)

### 4. Код приложения

#### speech_recognizer.py
- Принудительное использование CPU: `self.device = "cpu"`
- Убраны проверки CUDA и GPU-специфичное логирование
- Отключен fp16: `fp16=False`
- Убраны операции с GPU памятью

#### speaker_recognizer.py
- Принудительное использование CPU: `self.device = torch.device("cpu")`
- Убраны операции очистки GPU памяти

#### utils.py
- Упрощена функция `custom_fwd` для работы с CPU

## Преимущества CPU версии

1. **Универсальность**: Работает на любом устройстве
2. **Простота развертывания**: Не требует драйверов NVIDIA
3. **Совместимость**: Работает в облачных средах без GPU
4. **Стабильность**: Меньше зависимостей от оборудования

## Ограничения

1. **Производительность**: Распознавание будет медленнее
2. **Память**: Может потребоваться больше RAM
3. **Время обработки**: Увеличение времени транскрибации

## Рекомендации по производительности

1. **RAM**: Минимум 4GB, рекомендуется 8GB+
2. **CPU**: Процессор с поддержкой AVX2
3. **Модель Whisper**: Используйте "small" или "base" для ускорения
4. **Размер файлов**: Ограничьте размер обрабатываемых файлов

## Запуск

```bash
# Сборка и запуск
docker-compose up --build

# Проверка логов
docker-compose logs -f web
```

## Тестирование

```bash
# Запуск тестов
docker-compose exec web pytest

# Проверка работы приложения
curl http://localhost:5000
```

## Обратная совместимость

Все изменения обратно совместимы. Если у вас есть GPU и вы хотите использовать его:

1. Восстановите оригинальный Dockerfile с CUDA
2. Добавьте GPU настройки в docker-compose.yml
3. Измените код для автоматического определения устройства

## Поддержка

При возникновении проблем:
1. Проверьте логи: `docker-compose logs web`
2. Убедитесь в достаточности RAM
3. Проверьте поддержку AVX2 вашим процессором 